# CLAUDE.md - roji é–‹ç™ºã‚¬ã‚¤ãƒ‰

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

**roji**ï¼ˆè·¯åœ°ï¼‰ã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒå°‚ç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã€‚Docker Composeã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’è‡ªå‹•æ¤œå‡ºã—ã€`*.localhost` ã§HTTPSã‚¢ã‚¯ã‚»ã‚¹ã‚’å¯èƒ½ã«ã™ã‚‹ã€‚

> "æœ¬ç•ªã¯é«˜é€Ÿé“è·¯ï¼ˆTraefikï¼‰ã€é–‹ç™ºã¯è·¯åœ°è£ï¼ˆrojiï¼‰ã§"

### è¨€èªãƒ«ãƒ¼ãƒ«

- **CLAUDE.md**: æ—¥æœ¬èªï¼ˆé–‹ç™ºè€…å‘ã‘å†…éƒ¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰
- **ãã®ä»–ã™ã¹ã¦**: è‹±èªï¼ˆREADME.mdã€CONTRIBUTING.mdã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã€ã‚³ãƒ¡ãƒ³ãƒˆï¼‰

### ã‚³ãƒ³ã‚»ãƒ—ãƒˆ

- **Traefikã‚ˆã‚Šè»½é‡ãƒ»ã‚·ãƒ³ãƒ—ãƒ«**: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã«ç‰¹åŒ–ã™ã‚‹ã“ã¨ã§è¤‡é›‘ãªæ©Ÿèƒ½ã‚’çœç•¥
- **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ™ãƒ¼ã‚¹ã®è‡ªå‹•æ¤œå‡º**: å…±æœ‰ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶š = ãƒ—ãƒ­ã‚­ã‚·å¯¾è±¡
- **ã‚¼ãƒ­ã‚³ãƒ³ãƒ•ã‚£ã‚°å¿—å‘**: ãƒ©ãƒ™ãƒ«ãªã—ã§ã‚‚å‹•ä½œã€å¿…è¦ã«å¿œã˜ã¦ãƒ©ãƒ™ãƒ«ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **è¨€èª**: Go 1.25+
- **ä¸»è¦ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
  - `github.com/docker/docker/client` - Docker API
  - `net/http/httputil` - ReverseProxyï¼ˆæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
  - `crypto/x509`, `crypto/tls` - è¨¼æ˜æ›¸ç”Ÿæˆï¼ˆæ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰
- **é…å¸ƒ**: Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ (ghcr.io/kan/roji)

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         roji                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Docker     â”‚  â”‚    Route     â”‚  â”‚   HTTP/HTTPS     â”‚  â”‚
â”‚  â”‚   Watcher    â”‚â†’ â”‚   Manager    â”‚â†’ â”‚  Reverse Proxy   â”‚  â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â†“                                     â†‘             â”‚
â”‚   Docker Socket                          :80 / :443         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Shared Network: "roji" (or custom)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ web        â”‚  â”‚ api        â”‚  â”‚ app        â”‚            â”‚
â”‚  â”‚ :80        â”‚  â”‚ :8080      â”‚  â”‚ :3000      â”‚            â”‚
â”‚  â”‚ web.       â”‚  â”‚ api.       â”‚  â”‚ app.       â”‚            â”‚
â”‚  â”‚ localhost  â”‚  â”‚ localhost  â”‚  â”‚ localhost  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
roji/
â”œâ”€â”€ main.go                   # ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ internal/
â”‚   â”œâ”€â”€ docker/
â”‚   â”‚   â”œâ”€â”€ client.go         # Docker API ãƒ©ãƒƒãƒ‘ãƒ¼
â”‚   â”‚   â””â”€â”€ watcher.go        # Events ç›£è¦–
â”‚   â”œâ”€â”€ proxy/
â”‚   â”‚   â”œâ”€â”€ handler.go        # ReverseProxy å®Ÿè£…
â”‚   â”‚   â””â”€â”€ router.go         # ãƒ›ã‚¹ãƒˆå/ãƒ‘ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
â”‚   â”œâ”€â”€ certs/
â”‚   â”‚   â””â”€â”€ generator.go      # è¨¼æ˜æ›¸ç”Ÿæˆï¼ˆæœªå®Ÿè£…ï¼‰
â”‚   â””â”€â”€ config/
â”‚       â””â”€â”€ labels.go         # ãƒ©ãƒ™ãƒ«ãƒ‘ãƒ¼ã‚µãƒ¼
â”œâ”€â”€ examples/
â”‚   â””â”€â”€ docker-compose.yml    # ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚µãƒ³ãƒ—ãƒ«
â”œâ”€â”€ Dockerfile                # ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆdevelopment + productionï¼‰
â”œâ”€â”€ docker-compose.yml        # é–‹ç™ºç”¨ï¼ˆair ã§ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
â”œâ”€â”€ .air.toml                 # ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰è¨­å®š
â”œâ”€â”€ .env.example              # ç’°å¢ƒå¤‰æ•°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ README.md
â”œâ”€â”€ CLAUDE.md                 # é–‹ç™ºã‚¬ã‚¤ãƒ‰
â””â”€â”€ CONTRIBUTING.md           # é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
```

## è¨­è¨ˆä»•æ§˜

### ã‚µãƒ¼ãƒ“ã‚¹ãƒ‡ã‚£ã‚¹ã‚«ãƒãƒªãƒ¼

1. **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ™ãƒ¼ã‚¹**: `roji` ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«æ¥ç¶šã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠã‚’è‡ªå‹•æ¤œå‡º
2. **ãƒãƒ¼ãƒˆæ¤œå‡º**: `EXPOSE` ã•ã‚ŒãŸãƒãƒ¼ãƒˆã‚’ä½¿ç”¨ï¼ˆè¤‡æ•°ã‚ã‚‹å ´åˆã¯æœ€åˆã®ã‚‚ã®ã€ã¾ãŸã¯ãƒ©ãƒ™ãƒ«ã§æŒ‡å®šï¼‰
3. **ãƒ›ã‚¹ãƒˆåç”Ÿæˆ**: `com.docker.compose.service` ãƒ©ãƒ™ãƒ« â†’ `{service}.{base_domain}`

### ãƒ©ãƒ™ãƒ«ä»•æ§˜

| ãƒ©ãƒ™ãƒ« | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
|--------|------|-----------|
| `roji.host` | ã‚«ã‚¹ã‚¿ãƒ ãƒ›ã‚¹ãƒˆå | `{service}.localhost` |
| `roji.port` | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒãƒ¼ãƒˆ | æœ€åˆã®EXPOSEãƒãƒ¼ãƒˆ |
| `roji.path` | ãƒ‘ã‚¹ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ | ãªã— |

**ä¾‹:**
```yaml
services:
  api:
    image: my-api
    labels:
      - "roji.host=api.myproject.localhost"
      - "roji.port=3000"
    networks:
      - roji
```

### ç’°å¢ƒå¤‰æ•° / ãƒ•ãƒ©ã‚°

| ç’°å¢ƒå¤‰æ•° | ãƒ•ãƒ©ã‚° | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
|----------|--------|------|-----------|
| `ROJI_NETWORK` | `-network` | ç›£è¦–ã™ã‚‹Dockerãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ | `roji` |
| `ROJI_DOMAIN` | `-domain` | ãƒ™ãƒ¼ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³ | `localhost` |
| `ROJI_HTTP_PORT` | `-http-port` | HTTPãƒãƒ¼ãƒˆï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç”¨ï¼‰ | `80` |
| `ROJI_HTTPS_PORT` | `-https-port` | HTTPSãƒãƒ¼ãƒˆ | `443` |
| `ROJI_CERTS_DIR` | `-certs-dir` | è¨¼æ˜æ›¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª | `/certs` |
| `ROJI_AUTO_CERT` | `-auto-cert` | è¨¼æ˜æ›¸è‡ªå‹•ç”Ÿæˆ | `true` |
| `ROJI_DASHBOARD` | `-dashboard` | ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãƒ›ã‚¹ãƒˆå | `roji.localhost` |
| `ROJI_LOG_LEVEL` | `-log-level` | ãƒ­ã‚°ãƒ¬ãƒ™ãƒ« | `info` |

## å®Ÿè£…ã®æ³¨æ„ç‚¹

### Docker API

```go
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆæ™‚ã¯å¿…ãš API ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚´ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹ã«
client.NewClientWithOpts(client.FromEnv, client.WithAPIVersionNegotiation())

// ã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†…IPã‚’å–å¾—
network := container.NetworkSettings.Networks[networkName]
ip := network.IPAddress  // ã“ã‚Œã‚’ä½¿ã£ã¦ãƒ—ãƒ­ã‚­ã‚·

// EXPOSEãƒãƒ¼ãƒˆã®å–å¾—
for portSpec := range container.Config.ExposedPorts {
    // portSpec ã¯ "3000/tcp" å½¢å¼
    portStr := strings.Split(string(portSpec), "/")[0]
}

// docker-compose ã®ã‚µãƒ¼ãƒ“ã‚¹å
serviceName := container.Config.Labels["com.docker.compose.service"]
```

### ReverseProxy

```go
// httputil.ReverseProxy ã‚’ä½¿ç”¨
proxy := httputil.NewSingleHostReverseProxy(targetURL)

// Director ã§ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
proxy.Director = func(req *http.Request) {
    // X-Forwarded-* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
    req.Header.Set("X-Forwarded-Host", originalHost)
    req.Header.Set("X-Forwarded-Proto", "https")
    
    // ãƒ‘ã‚¹ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ï¼ˆãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å ´åˆï¼‰
    if pathPrefix != "" {
        req.URL.Path = strings.TrimPrefix(req.URL.Path, pathPrefix)
    }
}

// ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
proxy.ErrorHandler = func(w http.ResponseWriter, r *http.Request, err error) {
    // 502 Bad Gateway ã‚’è¿”ã™
}
```

### è¨¼æ˜æ›¸ç”Ÿæˆ

```go
// CAè¨¼æ˜æ›¸ã®ç”Ÿæˆ
ca := &x509.Certificate{
    SerialNumber: big.NewInt(1),
    Subject: pkix.Name{
        Organization: []string{"roji Dev CA"},
        CommonName:   "roji CA",
    },
    NotBefore:             time.Now(),
    NotAfter:              time.Now().AddDate(10, 0, 0), // 10å¹´
    IsCA:                  true,
    KeyUsage:              x509.KeyUsageCertSign | x509.KeyUsageCRLSign,
    BasicConstraintsValid: true,
}

// ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ï¼ˆãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å¯¾å¿œï¼‰
serverCert := &x509.Certificate{
    DNSNames: []string{
        "*." + baseDomain,  // *.kan.localhost
        baseDomain,         // kan.localhost
        "localhost",
    },
    // ...
}
```

### ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

```go
// ãƒ›ã‚¹ãƒˆåã®æ­£è¦åŒ–ï¼ˆãƒãƒ¼ãƒˆé™¤å»ã€å°æ–‡å­—åŒ–ï¼‰
func normalizeHost(host string) string {
    if idx := strings.LastIndex(host, ":"); idx != -1 {
        host = host[:idx]
    }
    return strings.ToLower(host)
}

// ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯ longest match å„ªå…ˆ
// /api/v2 â†’ /api ã‚ˆã‚Šå„ªå…ˆ
```

### å‹•çš„æ›´æ–°

```go
// Docker Events API ã§ã‚³ãƒ³ãƒ†ãƒŠã®é–‹å§‹/åœæ­¢ã‚’ç›£è¦–
filterArgs := filters.NewArgs()
filterArgs.Add("type", "container")
filterArgs.Add("event", "start")
filterArgs.Add("event", "stop")
filterArgs.Add("event", "die")

msgCh, errCh := dockerClient.Events(ctx, events.ListOptions{
    Filters: filterArgs,
})

// ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ™‚ã«ãƒ«ãƒ¼ãƒˆã‚’æ›´æ–°
// start â†’ GetBackend() â†’ AddBackend()
// stop/die â†’ RemoveBackend()
```

## æ©Ÿèƒ½å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: ã‚³ã‚¢æ©Ÿèƒ½ âœ…

- [x] Docker API ã§ã‚³ãƒ³ãƒ†ãƒŠä¸€è¦§å–å¾—
- [x] ãƒ©ãƒ™ãƒ«ã‹ã‚‰ãƒ«ãƒ¼ãƒˆæƒ…å ±æŠ½å‡º
- [x] httputil.ReverseProxy ã§ãƒ—ãƒ­ã‚­ã‚·
- [x] ãƒ›ã‚¹ãƒˆåãƒ™ãƒ¼ã‚¹ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- [x] ãƒ™ãƒ¼ã‚¹ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šã®å¯å¤‰åŒ–ï¼ˆ`ROJI_DOMAIN`ï¼‰

### Phase 2: å‹•çš„æ›´æ–° âœ…

- [x] Docker Events ç›£è¦–
- [x] ãƒ«ãƒ¼ãƒˆã®å‹•çš„è¿½åŠ /å‰Šé™¤
- [x] graceful shutdown

### Phase 3: TLS âœ…

- [x] è¨¼æ˜æ›¸ã®èª­ã¿è¾¼ã¿ï¼ˆå¤–éƒ¨ç”Ÿæˆ / mkcertï¼‰
- [x] è¨¼æ˜æ›¸ã®è‡ªå‹•ç”Ÿæˆï¼ˆmkcertä¸è¦ã€CAå«ã‚€ï¼‰
  - [x] CAè¨¼æ˜æ›¸ç”Ÿæˆï¼ˆECDSA P-256ã€10å¹´æœ‰åŠ¹ï¼‰
  - [x] ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ç”Ÿæˆï¼ˆãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰å¯¾å¿œã€1å¹´æœ‰åŠ¹ï¼‰
  - [x] Windowsç”¨DERå½¢å¼ï¼ˆ.crtï¼‰å‡ºåŠ›
- [x] HTTP â†’ HTTPS ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

### Phase 4: å“è³ª ğŸ”„

- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè£…
- [ ] ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ

### Phase 5: é…å¸ƒ ğŸ”„

- [ ] GitHub Actions CI/CD
  - [ ] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  - [ ] Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
  - [ ] ghcr.io ã¸ã®è‡ªå‹•ãƒ—ãƒƒã‚·ãƒ¥
- [ ] install.shï¼ˆcurl | bash ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰

### Phase 6: ä¾¿åˆ©æ©Ÿèƒ½

- [x] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒ«ãƒ¼ãƒˆä¸€è¦§è¡¨ç¤ºï¼‰
- [ ] CLI ãƒ«ãƒ¼ãƒˆä¸€è¦§è¡¨ç¤ºï¼ˆ`roji routes`ï¼‰
- [ ] ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

## å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ä»•æ§˜

### è¨¼æ˜æ›¸ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

```
certs/
â”œâ”€â”€ ca.pem          # CAè¨¼æ˜æ›¸ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
â”œâ”€â”€ ca-key.pem      # CAç§˜å¯†éµ
â”œâ”€â”€ cert.pem        # ã‚µãƒ¼ãƒãƒ¼è¨¼æ˜æ›¸ï¼ˆrojiãŒä½¿ç”¨ï¼‰
â””â”€â”€ key.pem         # ã‚µãƒ¼ãƒãƒ¼ç§˜å¯†éµ
```

### èµ·å‹•æ™‚ã®æ¡ˆå†…è¡¨ç¤º

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ğŸ›¤ï¸  roji - ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·                      â•‘
â•‘                                                               â•‘
â•‘  ğŸ“ CAè¨¼æ˜æ›¸: ./certs/ca.pem                                   â•‘
â•‘  ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦HTTPSã‚’ä¿¡é ¼ã—ã¦ãã ã•ã„                â•‘
â•‘                                                               â•‘
â•‘  macOS:   open ./certs/ca.pem â†’ ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã§ã€Œå¸¸ã«ä¿¡é ¼ã€      â•‘
â•‘  Linux:   ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨¼æ˜æ›¸è¨­å®šã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ                     â•‘
â•‘  Windows: ca.pem ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ â†’ è¨¼æ˜æ›¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ Registered Routes:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  https://api.kan.localhost/ -> 172.18.0.3:3000 (api)
  https://web.kan.localhost/ -> 172.18.0.4:80 (web)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

## ãƒ†ã‚¹ãƒˆæ–¹æ³•

### æ‰‹å‹•ãƒ†ã‚¹ãƒˆç”¨ docker-compose.yml

```yaml
# test/docker-compose.yml
services:
  # åŸºæœ¬ã‚±ãƒ¼ã‚¹: è‡ªå‹•æ¤œå‡º
  web:
    image: nginx:alpine
    networks:
      - roji

  # ã‚«ã‚¹ã‚¿ãƒ ãƒ›ã‚¹ãƒˆå
  api:
    image: nginx:alpine
    labels:
      - "roji.host=api.myapp.localhost"
    networks:
      - roji

  # ãƒãƒ¼ãƒˆæŒ‡å®š
  app:
    image: node:20-alpine
    command: ["npx", "http-server", "-p", "3000"]
    expose:
      - "3000"
      - "9229"
    labels:
      - "roji.port=3000"
    networks:
      - roji

networks:
  roji:
    external: true
```

### ç¢ºèªã‚³ãƒãƒ³ãƒ‰

```bash
# ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä½œæˆ
docker network create roji

# roji èµ·å‹•
docker compose up -d

# ãƒ†ã‚¹ãƒˆã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•
cd test && docker compose up -d

# å‹•ä½œç¢ºèª
curl -k https://web.localhost
curl -k https://api.myapp.localhost

# ãƒ«ãƒ¼ãƒˆç¢ºèª
docker logs roji
```

## ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–

### `.localhost` ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒè§£æ±ºã§ããªã„

- **macOS**: è‡ªå‹•ã§ `127.0.0.1` ã«è§£æ±ºã•ã‚Œã‚‹
- **Linux**: `/etc/hosts` ã«è¿½åŠ ã€ã¾ãŸã¯ `*.lvh.me` ã‚’ä½¿ç”¨

### ã‚³ãƒ³ãƒ†ãƒŠãŒæ¤œå‡ºã•ã‚Œãªã„

1. `docker network inspect roji` ã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç¢ºèª
2. `docker inspect <container> | jq '.[0].Config.ExposedPorts'` ã§ãƒãƒ¼ãƒˆç¢ºèª
3. `roji.self=true` ãƒ©ãƒ™ãƒ«ãŒã¤ã„ã¦ã„ãªã„ã‹ç¢ºèª

### è¨¼æ˜æ›¸ã‚¨ãƒ©ãƒ¼

CAè¨¼æ˜æ›¸ãŒãƒ–ãƒ©ã‚¦ã‚¶/OSã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

## å‚è€ƒãƒªãƒ³ã‚¯

- [Docker Engine API](https://docs.docker.com/engine/api/)
- [Go httputil.ReverseProxy](https://pkg.go.dev/net/http/httputil#ReverseProxy)
- [Traefik](https://doc.traefik.io/traefik/) - è¨­è¨ˆã®å‚è€ƒ
